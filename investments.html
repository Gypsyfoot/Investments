<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investments</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
    background: #f5f5f5;
  }
  h1 {
    text-align: center;
  }
  table {
    width: 100%;
    background: white;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: right;
  }
  th:first-child, td:first-child {
    text-align: left;
  }
  .manual {
    color: #555;
    font-style: italic;
  }
  #totals {
    margin-top: 20px;
    font-size: 1.1em;
  }
  button {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-top: 12px;
  }
  .secondary {
    background: #eee;
  }
</style>
</head>
<body>

<h1>Investments (Â£)</h1>

<table>
  <thead>
    <tr>
      <th>Holding</th>
      <th>Units</th>
      <th>Price (Â£)</th>
      <th>Value (Â£)</th>
    </tr>
  </thead>
  <tbody id="portfolio"></tbody>
</table>

<div id="totals">
  <div id="fundSubtotal"></div>
  <div id="etfSubtotal"></div>
  <div id="grandTotal" style="font-size:1.3em;font-weight:bold;"></div>
</div>

<button onclick="loadPrices()">Refresh Prices</button>
<button class="secondary" onclick="clearCache()">Clear cache / re-enter fund price</button>

<script>
/* ================= CONFIG ================= */

const API_KEY = "TX9DIBISXPWNA4LR";

const holdings = [
  {
    name: "Artemis SmartGARP UK Equity Fund Class C Acc GBP",
    units: 1473.492,
    type: "manual"
  },
  {
    name: "FTSE All-World UCITS ETF",
    symbol: "VWRP.L",
    units: 393,
    type: "auto",
    priceUnit: "GBP"
  },
  {
    name: "FTSE All-World High Dividend Yield UCITS ETF",
    symbol: "VHYG.L",
    units: 693,
    type: "auto",
    priceUnit: "GBX"   // â† priced in pence
  }
];

const FUND_PRICE_KEY = "artemis_price";
const FUND_DATE_KEY  = "artemis_date";

/* ================= HELPERS ================= */

const fmtPrice = n =>
  "Â£" + n.toLocaleString("en-GB", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });

const fmtValue = n =>
  "Â£" + Math.round(n).toLocaleString("en-GB");

const sleep = ms => new Promise(r => setTimeout(r, ms));

async function getPrice(symbol) {
  const url =
    `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  const quote = data["Global Quote"];
  if (!quote || !quote["05. price"]) return null;

  return parseFloat(quote["05. price"]);
}

function getManualFundPrice() {
  let price = localStorage.getItem(FUND_PRICE_KEY);

  if (!price) {
    price = prompt("Enter latest Artemis fund NAV (GBP):");
    if (!price) return null;

    localStorage.setItem(FUND_PRICE_KEY, price);
    localStorage.setItem(FUND_DATE_KEY, new Date().toLocaleDateString());
  }

  return parseFloat(price);
}

/* ================= CACHE ================= */

function clearCache() {
  if (!confirm("Clear saved fund price and reset app?")) return;
  localStorage.removeItem(FUND_PRICE_KEY);
  localStorage.removeItem(FUND_DATE_KEY);
  loadPrices();
}

/* ================= MAIN ================= */

async function loadPrices() {
  const tbody = document.getElementById("portfolio");
  tbody.innerHTML = "";

  let fundSubtotal = 0;
  let etfSubtotal  = 0;

  for (const h of holdings) {
    let price = null;
    let value = null;

    if (h.type === "manual") {
      price = getManualFundPrice();
      if (price === null || isNaN(price)) return;

      value = price * h.units;
      fundSubtotal += value;

      const date = localStorage.getItem(FUND_DATE_KEY);

      tbody.innerHTML += `
        <tr class="manual">
          <td>${h.name}<br><small>NAV updated: ${date}</small></td>
          <td>${h.units.toLocaleString()}</td>
          <td>${fmtPrice(price)}</td>
          <td>${fmtValue(value)}</td>
        </tr>
      `;
    } else {
      price = await getPrice(h.symbol);
      if (price === null) continue;

      // ðŸ”‘ Convert pence â†’ pounds if needed
      if (h.priceUnit === "GBX") {
        price = price / 100;
      }

      value = price * h.units;
      etfSubtotal += value;

      tbody.innerHTML += `
        <tr>
          <td>${h.name}</td>
          <td>${h.units.toLocaleString()}</td>
          <td>${fmtPrice(price)}</td>
          <td>${fmtValue(value)}</td>
        </tr>
      `;

      // Prevent API throttling
      await sleep(1200);
    }
  }

  document.getElementById("fundSubtotal").innerText =
    "Fund subtotal: " + fmtValue(fundSubtotal);

  document.getElementById("etfSubtotal").innerText =
    "ETF subtotal: " + fmtValue(etfSubtotal);

  document.getElementById("grandTotal").innerText =
    "Total portfolio value: " +
    fmtValue(fundSubtotal + etfSubtotal);
}

loadPrices();
</script>

</body>
</html>
