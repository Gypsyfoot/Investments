<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<title>My Portfolio (GBP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; background: #f5f5f5; max-width: 850px; margin: 0 auto; }
  h1 { text-align: center; color: #333; margin-bottom: 25px; }
  table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
  th, td { padding: 14px; border-bottom: 1px solid #eee; text-align: right; }
  th:first-child, td:first-child { text-align: left; }
  th { background-color: #f8f9fa; color: #555; font-size: 0.85em; text-transform: uppercase; }
  .manual { color: #666; font-style: italic; background-color: #fffdf5; }
  #totals { margin-top: 25px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1.1em; }
  .grand-total { font-size: 1.4em; font-weight: bold; border-top: 2px solid #333; padding-top: 15px; margin-top: 12px; }
  .button-group { display: flex; gap: 12px; margin-top: 25px; }
  button { flex: 1; padding: 14px; font-size: 1em; font-weight: 600; cursor: pointer; border: none; border-radius: 6px; background-color: #007bff; color: white; transition: 0.2s; }
  button:hover { background-color: #0056b3; }
  .btn-reset { background-color: #6c757d; }
  #timestamp { text-align: center; font-size: 0.85em; color: #888; margin-top: 20px; }
</style>
</head>
<body>

<h1>My Portfolio (£)</h1>

<table>
  <thead>
    <tr>
      <th>Holding</th>
      <th>Units</th>
      <th>Price (£)</th>
      <th>Value (£)</th>
    </tr>
  </thead>
  <tbody id="portfolio">
    <tr><td colspan="4" style="text-align:center; padding: 40px;">Fetching Live Prices...</td></tr>
  </tbody>
</table>

<div id="totals">
  <div class="total-row"><span>Fund Subtotal:</span> <span id="fundSubtotal">£0</span></div>
  <div class="total-row"><span>ETF Subtotal:</span> <span id="etfSubtotal">£0</span></div>
  <div class="total-row grand-total"><span>Total Portfolio Value:</span> <span id="grandTotal">£0</span></div>
</div>

<div class="button-group">
  <button onclick="loadPrices()">Refresh Prices</button>
  <button class="btn-reset" onclick="resetManualPrice()">Reset Manual Price</button>
</div>

<div id="timestamp"></div>

<script>
const FUND_PRICE_KEY = "artemis_price_2026";
const FUND_DATE_KEY  = "artemis_date_2026";

const holdings = [
  { name: "Artemis SmartGARP UK Equity", units: 1473.492, type: "manual" },
  { name: "FTSE All-World ETF", symbol: "VWRP.L", units: 393, type: "auto" },
  { name: "FTSE High Div Yield ETF", symbol: "VHYG.L", units: 693, type: "auto" }
];

const fmtPrice = n => "£" + n.toLocaleString("en-GB", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtWhole = n => "£" + Math.round(n).toLocaleString("en-GB");

/**
 * Uses a CORS proxy to fetch from Yahoo Finance.
 */
async function getYahooPrice(symbol) {
  try {
    // 2026 Workaround: Using a CORS-anywhere proxy to bypass browser blocks
    const targetUrl = `https://query1.finance.yahoo.com{symbol}`;
    const proxyUrl = `https://api.allorigins.win{encodeURIComponent(targetUrl)}`;
    
    const res = await fetch(proxyUrl);
    const container = await res.json();
    const data = JSON.parse(container.contents);
    
    const price = data.chart.result[0].meta.regularMarketPrice;
    return price || null;
  } catch (e) {
    console.error(`Error for ${symbol}:`, e);
    return null;
  }
}

function getManualFundPrice() {
  let price = localStorage.getItem(FUND_PRICE_KEY);
  if (!price) {
    price = prompt("Enter latest Artemis fund NAV (GBP):");
    if (!price || isNaN(price)) return null;
    localStorage.setItem(FUND_PRICE_KEY, price);
    localStorage.setItem(FUND_DATE_KEY, new Date().toLocaleDateString('en-GB'));
  }
  return parseFloat(price);
}

function resetManualPrice() {
  localStorage.removeItem(FUND_PRICE_KEY);
  localStorage.removeItem(FUND_DATE_KEY);
  alert("Manual price cleared.");
  loadPrices();
}

async function loadPrices() {
  const tbody = document.getElementById("portfolio");
  tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding: 20px;'>Updating Live Prices...</td></tr>";

  let fundSubtotal = 0, etfSubtotal = 0, rowsHtml = "";

  for (const h of holdings) {
    if (h.type === "manual") {
      const price = getManualFundPrice();
      if (price) {
        const val = price * h.units;
        fundSubtotal += val;
        rowsHtml += `<tr class="manual"><td>${h.name}<br><small>NAV: ${localStorage.getItem(FUND_DATE_KEY)}</small></td><td>${h.units.toLocaleString()}</td><td>${fmtPrice(price)}</td><td>${fmtWhole(val)}</td></tr>`;
      }
    } else {
      const price = await getYahooPrice(h.symbol);
      if (price) {
        const val = price * h.units;
        etfSubtotal += val;
        rowsHtml += `<tr><td>${h.name} (${h.symbol})</td><td>${h.units.toLocaleString()}</td><td>${fmtPrice(price)}</td><td>${fmtWhole(val)}</td></tr>`;
      } else {
        rowsHtml += `<tr><td>${h.name}</td><td colspan="3" style="color:#d9534f; text-align:center;">Connection Error (Try again in a moment)</td></tr>`;
      }
    }
  }

  tbody.innerHTML = rowsHtml;
  document.getElementById("fundSubtotal").innerText = fmtWhole(fundSubtotal);
  document.getElementById("etfSubtotal").innerText = fmtWhole(etfSubtotal);
  document.getElementById("grandTotal").innerText = fmtWhole(fundSubtotal + etfSubtotal);
  document.getElementById("timestamp").innerText = "Last checked: " + new Date().toLocaleString('en-GB');
}

loadPrices();
</script>
</body>
</html>
