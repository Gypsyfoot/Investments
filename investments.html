<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<title>My Portfolio Tracker (£)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f2f5; max-width: 800px; margin: 0 auto; color: #333; }
  h1 { text-align: center; margin-bottom: 25px; }
  table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
  th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: right; }
  th:first-child, td:first-child { text-align: left; }
  th { background-color: #f8f9fa; color: #666; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; }
  .manual { background-color: #fffdf5; font-style: italic; color: #555; }
  #totals { margin-top: 25px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
  .grand-total { font-size: 1.5em; font-weight: bold; border-top: 2px solid #222; padding-top: 15px; margin-top: 10px; color: #000; }
  .button-group { display: flex; gap: 15px; margin-top: 25px; }
  button { flex: 1; padding: 15px; font-size: 1em; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; background-color: #007bff; color: white; transition: 0.2s; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  .btn-reset { background-color: #6c757d; }
  #timestamp { text-align: center; font-size: 0.85em; color: #888; margin-top: 20px; }
  .status-msg { color: #007bff; font-weight: bold; }
</style>
</head>
<body>

<h1>My Portfolio (£)</h1>

<table>
  <thead>
    <tr>
      <th>Holding</th>
      <th>Units</th>
      <th>Price (£)</th>
      <th>Value (£)</th>
    </tr>
  </thead>
  <tbody id="portfolio">
    <tr><td colspan="4" style="text-align:center; padding: 40px;">Initialising Tracker...</td></tr>
  </tbody>
</table>

<div id="totals">
  <div class="total-row"><span>Fund Subtotal:</span> <span id="fundSubtotal">£0</span></div>
  <div class="total-row"><span>ETF Subtotal:</span> <span id="etfSubtotal">£0</span></div>
  <div class="total-row grand-total"><span>Total Portfolio:</span> <span id="grandTotal">£0</span></div>
</div>

<div class="button-group">
  <button id="refreshBtn" onclick="loadPrices()">Refresh Prices</button>
  <button class="btn-reset" onclick="resetManualPrice()">Reset Manual Price</button>
</div>

<div id="timestamp"></div>

<script>
/**
 * SETTINGS
 * Note: .LON is the required suffix for LSE stocks on Alpha Vantage
 */
const API_KEY = "TX9DIBISXPWNA4LR"; 
const holdings = [
  { name: "Artemis SmartGARP UK Equity", units: 1473.492, type: "manual" },
  { name: "VWRP.L FTSE All-World ETF", symbol: "VWRP.LON", units: 393, type: "auto" },
  { name: "VHYG.L FTSE High Div Yield ETF", symbol: "VHYG.LON", units: 693, type: "auto" }
];

const fmtPrice = n => "£" + n.toLocaleString("en-GB", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtWhole = n => "£" + Math.round(n).toLocaleString("en-GB");
const sleep = ms => new Promise(res => setTimeout(res, ms));

async function fetchPrice(symbol) {
  const url = `https://www.alphavantage.co{symbol}&apikey=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    // Check for API pacing limit (standard on free tier)
    if (data["Note"] || data["Information"]) {
      console.warn("API limit hit, retrying in 15 seconds...");
      return "RETRY";
    }
    
    const price = data["Global Quote"] ? parseFloat(data["Global Quote"]["05. price"]) : null;
    return price;
  } catch (e) {
    return null;
  }
}

function getManualPrice() {
  let p = localStorage.getItem("artemis_nav");
  if (!p) {
    p = prompt("Enter latest Artemis Fund NAV (£):");
    if (!p || isNaN(p)) return null;
    localStorage.setItem("artemis_nav", p);
    localStorage.setItem("artemis_date", new Date().toLocaleDateString('en-GB'));
  }
  return parseFloat(p);
}

function resetManualPrice() {
  localStorage.removeItem("artemis_nav");
  localStorage.removeItem("artemis_date");
  loadPrices();
}

async function loadPrices() {
  const tbody = document.getElementById("portfolio");
  const btn = document.getElementById("refreshBtn");
  btn.disabled = true;
  
  let fundSub = 0, etfSub = 0, rowsHtml = "";

  for (const h of holdings) {
    // UI Feedback for the current loop item
    tbody.innerHTML = rowsHtml + `<tr><td colspan="4" style="text-align:center" class="status-msg">Updating ${h.name}...</td></tr>`;
    
    if (h.type === "manual") {
      const p = getManualPrice();
      if (p) {
        const val = p * h.units;
        fundSub += val;
        rowsHtml += `<tr class="manual"><td>${h.name}<br><small>NAV: ${localStorage.getItem("artemis_date")}</small></td><td>${h.units.toLocaleString()}</td><td>${fmtPrice(p)}</td><td>${fmtWhole(val)}</td></tr>`;
      }
    } else {
      let price = await fetchPrice(h.symbol);
      
      // Automatic Retry Logic
      if (price === "RETRY") {
        tbody.innerHTML = rowsHtml + `<tr><td colspan="4" style="text-align:center" class="status-msg">API Busy... waiting 15s to retry ${h.symbol}</td></tr>`;
        await sleep(15000);
        price = await fetchPrice(h.symbol);
      }

      if (price && price !== "RETRY") {
        const val = price * h.units;
        etfSub += val;
        rowsHtml += `<tr><td>${h.name} (${h.symbol})</td><td>${h.units.toLocaleString()}</td><td>${fmtPrice(price)}</td><td>${fmtWhole(val)}</td></tr>`;
      } else {
        rowsHtml += `<tr><td>${h.name}</td><td colspan="3" style="color:red">Price Error (Limit Reached)</td></tr>`;
      }
    }
  }

  tbody.innerHTML = rowsHtml;
  document.getElementById("fundSubtotal").innerText = fmtWhole(fundSub);
  document.getElementById("etfSubtotal").innerText = fmtWhole(etfSub);
  document.getElementById("grandTotal").innerText = fmtWhole(fundSub + etfSub);
  document.getElementById("timestamp").innerText = "Last Update: " + new Date().toLocaleString('en-GB');
  btn.disabled = false;
}

// Initial Load
loadPrices();
</script>

</body>
</html>
