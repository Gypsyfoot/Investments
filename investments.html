<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investments</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
    background: #f5f5f5;
  }
  h1 {
    text-align: center;
  }
  .meta {
    text-align: center;
    font-size: 0.9em;
    color: #666;
  }
  table {
    width: 100%;
    background: white;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
    text-align: right;
  }
  th:first-child, td:first-child {
    text-align: left;
  }
  .manual {
    color: #555;
    font-style: italic;
  }
  #totals {
    margin-top: 20px;
    font-size: 1.1em;
  }
  button {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-top: 12px;
  }
  canvas {
    background: white;
    margin-top: 30px;
    padding: 10px;
  }
</style>
</head>
<body>

<h1>Investments (£)</h1>

<div class="meta">
  Prices: <strong>Delayed</strong><br>
  Last updated: <span id="lastUpdated">—</span>
</div>

<table>
  <thead>
    <tr>
      <th>Holding</th>
      <th>Units</th>
      <th>Price (£)</th>
      <th>Value (£)</th>
    </tr>
  </thead>
  <tbody id="portfolio"></tbody>
</table>

<div id="totals">
  <div id="fundSubtotal"></div>
  <div id="etfSubtotal"></div>
  <div id="grandTotal" style="font-size:1.3em;font-weight:bold;"></div>
</div>

<button onclick="loadPrices()">Refresh Prices</button>
<button onclick="clearCache()">Clear cache / re-enter fund price</button>

<canvas id="historyChart" height="220"></canvas>

<script>
/* ================= CONFIG ================= */

const API_KEY = "TX9DIBISXPWNA4LR";

const holdings = [
  {
    name: "Artemis SmartGARP UK Equity Fund Class C Acc GBP",
    units: 1473.492,
    type: "manual"
  },
  {
    name: "FTSE All-World UCITS ETF",
    symbol: "VWRP.L",
    units: 393,
    type: "auto",
    priceUnit: "GBP"
  },
  {
    name: "FTSE All-World High Dividend Yield UCITS ETF",
    symbol: "VHYG.L",
    units: 693,
    type: "auto",
    priceUnit: "GBX"
  }
];

const TODAY = new Date().toISOString().slice(0,10);

/* ================= HELPERS ================= */

const fmtPrice = n => "£" + n.toFixed(2);
const fmtValue = n => "£" + Math.round(n).toLocaleString("en-GB");
const sleep = ms => new Promise(r => setTimeout(r, ms));

function cacheKey(symbol) {
  return `price_${symbol}_${TODAY}`;
}

async function fetchETFPrice(symbol) {
  const cached = localStorage.getItem(cacheKey(symbol));
  if (cached) return parseFloat(cached);

  const url =
    `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();

  const quote = data["Global Quote"];
  if (!quote || !quote["05. price"]) return null;

  const price = parseFloat(quote["05. price"]);
  localStorage.setItem(cacheKey(symbol), price);
  return price;
}

function getManualFundPrice() {
  let price = localStorage.getItem("fund_price");
  if (!price) {
    price = prompt("Enter latest Artemis fund NAV (GBP):");
    if (!price) return null;
    localStorage.setItem("fund_price", price);
  }
  return parseFloat(price);
}

/* ================= HISTORY ================= */

function saveHistory(total) {
  const history = JSON.parse(localStorage.getItem("history") || "{}");
  history[TODAY] = Math.round(total);
  localStorage.setItem("history", JSON.stringify(history));
}

function drawHistory() {
  const history = JSON.parse(localStorage.getItem("history") || "{}");
  const labels = Object.keys(history);
  const data = Object.values(history);

  if (labels.length < 2) return;

  new Chart(document.getElementById("historyChart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Total Portfolio Value (£)",
        data,
        borderWidth: 2,
        fill: false
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          ticks: {
            callback: v => "£" + v.toLocaleString("en-GB")
          }
        }
      }
    }
  });
}

/* ================= CACHE ================= */

function clearCache() {
  if (!confirm("Clear all cached prices and history?")) return;
  localStorage.clear();
  location.reload();
}

/* ================= MAIN ================= */

async function loadPrices() {
  const tbody = document.getElementById("portfolio");
  tbody.innerHTML = "";

  let fundSubtotal = 0;
  let etfSubtotal = 0;

  for (const h of holdings) {
    let price;

    if (h.type === "manual") {
      price = getManualFundPrice();
      if (!price) return;

      const value = price * h.units;
      fundSubtotal += value;

      tbody.innerHTML += `
        <tr class="manual">
          <td>${h.name}</td>
          <td>${h.units.toLocaleString()}</td>
          <td>${fmtPrice(price)}</td>
          <td>${fmtValue(value)}</td>
        </tr>`;
    } else {
      price = await fetchETFPrice(h.symbol);
      if (!price) continue;

      if (h.priceUnit === "GBX") price /= 100;

      const value = price * h.units;
      etfSubtotal += value;

      tbody.innerHTML += `
        <tr>
          <td>${h.name}</td>
          <td>${h.units.toLocaleString()}</td>
          <td>${fmtPrice(price)}</td>
          <td>${fmtValue(value)}</td>
        </tr>`;

      await sleep(1200);
    }
  }

  const total = fundSubtotal + etfSubtotal;

  document.getElementById("fundSubtotal").innerText =
    "Fund subtotal: " + fmtValue(fundSubtotal);
  document.getElementById("etfSubtotal").innerText =
    "ETF subtotal: " + fmtValue(etfSubtotal);
  document.getElementById("grandTotal").innerText =
    "Total portfolio value: " + fmtValue(total);

  document.getElementById("lastUpdated").innerText =
    new Date().toLocaleString();

  saveHistory(total);
  drawHistory();
}

loadPrices();
</script>

</body>
</html>
